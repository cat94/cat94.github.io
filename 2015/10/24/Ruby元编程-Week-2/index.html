<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ben Wong,wenbinben@gmail.com"><title>Ruby元编程 星期二 · 沈小黑的菜园</title><meta name="description" content="解决代码重复在星期二，书中给出了一个关于包装老系统接口造成代码冗余的例子。下面是这个例子，它贯穿了整个章节，集中体现了Ruby道路的优越性+_+
有一个老系统，他有很多蹩脚的代码，现在要求系统自动为超过99美元的开销添加标记。

蹩脚的代码是这样的:
12345678910class DS	def "><meta name="keywords" content="Hexo,HTML,Ben,CSS,安卓,android,Linux,linuxdeepin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">沈小黑的菜园</a></h3><div class="description"><p>Nothing lasts forever.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/Ben_wenbin"><i class="fa fa-twitter"></i></a></li><li><a href="http://instagram.com/hwbinbenben"><i class="fa fa-instagram"></i></a></li><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/ben0036"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai</a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="https://secure.gravatar.com/avatar/e71df8021446fe9759a9928b1dd5c28d?s=180&amp;r=G&amp;d="></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Ruby元编程 星期二</a></h3></div><div class="post-content"><h1 id="解决代码重复"><a href="#解决代码重复" class="headerlink" title="解决代码重复"></a>解决代码重复</h1><p>在星期二，书中给出了一个关于包装老系统接口造成代码冗余的例子。下面是这个例子，它贯穿了整个章节，集中体现了Ruby道路的优越性+_+</p>
<p>有一个老系统，他有很多蹩脚的代码，现在要求系统自动为超过99美元的开销添加标记。</p>
<a id="more"></a>
<p>蹩脚的代码是这样的:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DS</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span> <span class="comment">#连接数据源</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_cpu_info</span><span class="params">(workstation_id)</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_cpu_price</span><span class="params">(workstation_id)</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_mouse_info</span><span class="params">(workstatin_id)</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_mouse_price</span><span class="params">(workstation_id)</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_keyboard_info</span><span class="params">(workstation_id)</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_keyboard_price</span><span class="params">(workstatin_id)</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_display_info</span><span class="params">(workstation_id)</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_display_price</span><span class="params">(workstatin_id)</span></span></div></pre></td></tr></table></figure>
<p>真够蹩脚的= =如果用简单的包装方法来完成这个需求的话，代码就会变成这样：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></div><div class="line">		@id = computer_id</div><div class="line">		@data_source = data_source</div><div class="line">	<span class="keyword">end</span></div><div class="line">		</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">mouse</span></span></div><div class="line">		info = @data_source.get_mouse_info(@id)</div><div class="line">		price = @data_source.get_mouse_price(@id)</div><div class="line">		result = <span class="string">"Mouse: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></div><div class="line">		<span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></div><div class="line">		result</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="comment">#cpu, keyboard等都是相似的代码</span></div><div class="line">	<span class="comment">#....  </span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>原谅我照抄书上的代码吧，要我写我也这么写+_+</p>
<p>呐~我们发现这些不同的部件代码都是相似的~怎么解决这个问题呢？首先祭出Ruby中的动态方法。</p>
<h1 id="动态方法"><a href="#动态方法" class="headerlink" title="动态方法"></a>动态方法</h1><p>动态方法分成两个部分：动态调用方法和动态创建方法。</p>
<h2 id="动态调用方法"><a href="#动态调用方法" class="headerlink" title="动态调用方法"></a>动态调用方法</h2><p>我们可以发现，这里的调用方法名其实是相似的，改变的只是 “get_#{设备名}_price” 中的facility。那么有没有办法可以直接把需要的设备名包装成 “get_#{设备名}_price” 的方法呢？</p>
<p>其实调用方法实际上是给一个对象发送消息，而Ruby正提供了一个send方法来支持通过发送消息的方式调用方法。</p>
<p>把这个技巧运用到Computer类中：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></div><div class="line">		@id = computer_id</div><div class="line">		@data_source = data_source</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">mouse</span></span></div><div class="line">		component <span class="symbol">:mouse</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">cpu</span></span></div><div class="line">		component <span class="symbol">:cpu</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">keyboard</span></span></div><div class="line">		component <span class="symbol">:keyboard</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">component</span><span class="params">(name)</span></span></div><div class="line">		info = @data_source.send <span class="string">"get_<span class="subst">#&#123;name&#125;</span>_info"</span>, @id</div><div class="line">		price = @data_source.send <span class="string">"get_<span class="subst">#&#123;name&#125;</span>_price"</span>, @id</div><div class="line">		result = <span class="string">"<span class="subst">#&#123;name.capitalize&#125;</span>: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></div><div class="line">		<span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></div><div class="line">		result</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>看起来简单了不少，至少所有的调用逻辑都放在同一个component方法里面了。但是仍然感觉有点不足：mouse、cpu、keyboard方法几乎都没有做什么事情，只是调用了component方法，这显得很多余。怎么解决这个问题呢？现在轮到动态创建方法登场了。</p>
<blockquote>
<p>其实用send需要注意的一点是它可以调用private方法，如果确定只需要调用public方法的话，最好还是public_send方法吧。</p>
</blockquote>
<h2 id="动态创建方法"><a href="#动态创建方法" class="headerlink" title="动态创建方法"></a>动态创建方法</h2><p>如果说动态调用方法在Java的语言机制中还能通过一定步骤实现的话，动态创建方法应该是Ruby的“独门绝技”了~Ruby可以通过Module#define_method方法随时定义一个方法，只需要提供方法名和充当方法主体的块。</p>
<p>再把动态创建方法糅合进Computer类中：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></div><div class="line">    @id = computer_id</div><div class="line">    @data_source = data_source</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">define_component</span><span class="params">(name)</span></span></div><div class="line">    define_method name <span class="keyword">do</span></div><div class="line">      info = @data_source.send <span class="string">"get_<span class="subst">#&#123;name&#125;</span>_info"</span>, @id</div><div class="line">      price = @data_source.send <span class="string">"get_<span class="subst">#&#123;name&#125;</span>_price"</span>, @id</div><div class="line">      result = <span class="string">"<span class="subst">#&#123;name.capitalize&#125;</span>: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></div><div class="line">      <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></div><div class="line">      result</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  define_component <span class="symbol">:mouse</span></div><div class="line">  define_component <span class="symbol">:cpu</span></div><div class="line">  define_component <span class="symbol">:keyboard</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>这样就不用一个个定义方法了，只需要在类中增加一条代码就会生成一个对应的方法，看起来又好了很多。</p>
<p>但是还是有问题：假如哪天采购部心血来潮新加了个数位板什么的，我们还要修改Computer类，这样耦合性是不是就有点高了？也许我们可以把DS类中所有”get_#{设备名}_price”格式的方法都读取出来，然后对应地创建动态方法，这就用到了Ruby的内省特性。</p>
<h2 id="利用内省优化"><a href="#利用内省优化" class="headerlink" title="利用内省优化"></a>利用内省优化</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></div><div class="line">    @id = computer_id</div><div class="line">    @data_source = data_source</div><div class="line"></div><div class="line">    data_source.public_methods.grep(<span class="regexp">/^get_(.*)_info/</span>)&#123;</div><div class="line">      Computer.define_component $1</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">define_component</span><span class="params">(name)</span></span></div><div class="line">    define_method name <span class="keyword">do</span></div><div class="line">      info = @data_source.send <span class="string">"get_<span class="subst">#&#123;name&#125;</span>_info"</span>, @id</div><div class="line">      price = @data_source.send <span class="string">"get_<span class="subst">#&#123;name&#125;</span>_price"</span>, @id</div><div class="line">      result = <span class="string">"<span class="subst">#&#123;name.capitalize&#125;</span>: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></div><div class="line">      <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></div><div class="line">      result</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>很完美，那么还有其他的方法么？</p>
<h1 id="幽灵方法"><a href="#幽灵方法" class="headerlink" title="幽灵方法"></a>幽灵方法</h1><p>在Ruby中，假如调用了一个找不到的方法，就会触发一个类似异常的，叫做method_missing的方法。所有找不到的方法都会跑到这里，那我们就可以通过修改method_missing来实现动态代理，做到神不知鬼不觉地在某些情况下完成某些功能。比如，我们根本没有定义cpu方法，但是在method_missing中增加了“如果找不到的方法名是cpu，那么返回cpu信息”的逻辑，那么依然可以实现我们的需求，而不需要定义任何新方法。</p>
<h2 id="利用幽灵方法重构Computer"><a href="#利用幽灵方法重构Computer" class="headerlink" title="利用幽灵方法重构Computer"></a>利用幽灵方法重构Computer</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></div><div class="line">    @id = computer_id</div><div class="line">    @data_source = data_source</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name)</span></span></div><div class="line">    <span class="keyword">super</span> <span class="keyword">if</span> !@data_source.respond_to?(<span class="string">"get_<span class="subst">#&#123;name&#125;</span>_info"</span>)  <span class="comment">#如果是其他的未定义方法，那就给默认的method_missing处理</span></div><div class="line">    info = @data_source.send <span class="string">"get_<span class="subst">#&#123;name&#125;</span>_info"</span>, @id</div><div class="line">    price = @data_source.send <span class="string">"get_<span class="subst">#&#123;name&#125;</span>_price"</span>, @id</div><div class="line">    result = <span class="string">"<span class="subst">#&#123;name.capitalize&#125;</span>: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></div><div class="line">    <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></div><div class="line">    result</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h2 id="respond-to-missing-方法"><a href="#respond-to-missing-方法" class="headerlink" title="respond_to_missing?方法"></a>respond_to_missing?方法</h2><p>如果调用Computer.respond_to?(:mouse) 它会返回false，因为根本就没有定义这个方法嘛~那假如想要让幽灵方法中处理的情况也能体现在respond_to?方法中呢？我们不必修改respond_to?方法，而可以修改respond_to_missing?方法。因为respond_to?会检查respond_to_missing?，如果返回为true的话，就可以判定为true了。</p>
<p>所以在这里，我们需要把respond_to_missing?改写：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></div><div class="line">	<span class="comment">#...</span></div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">respond_to_missing?</span><span class="params">(method, include_private = <span class="literal">false</span>)</span></span></div><div class="line">		@data_source.respond_to?(<span class="string">"get_<span class="subst">#&#123;method&#125;</span>_info"</span>) <span class="params">||</span> <span class="keyword">super</span></div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>P.S. 还有一个const_missing?方法，作用跟method_missing?类似，只是处理的是常量找不到的问题。如Rake中为兼容而允许在后续版本中使用先前没有命名空间的老名字，就是这么实现的：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Module</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">const_missing?</span><span class="params">(const_name)</span></span></div><div class="line">		<span class="keyword">case</span> const_name</div><div class="line">		<span class="keyword">when</span> <span class="symbol">:Task</span></div><div class="line">			Rake.application.const_warning(const_name)</div><div class="line">			Rake::Task</div><div class="line">		<span class="keyword">when</span> <span class="symbol">:FileTask</span></div><div class="line">			Rake.application.const_warning(const_name)</div><div class="line">			Rake:: FileTask</div><div class="line">		<span class="keyword">when</span> <span class="symbol">:FileCreationTask</span></div><div class="line">			<span class="comment">#...</span></div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h2 id="幽灵方法的陷阱"><a href="#幽灵方法的陷阱" class="headerlink" title="幽灵方法的陷阱"></a>幽灵方法的陷阱</h2><h3 id="无限循环的bug"><a href="#无限循环的bug" class="headerlink" title="无限循环的bug"></a>无限循环的bug</h3><p>如果我们写了如下一个程序：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Roulette</span></span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args)</span></span></div><div class="line">		<span class="number">3</span>.times <span class="keyword">do</span></div><div class="line">			number = rand(<span class="number">10</span>)+<span class="number">1</span></div><div class="line">		<span class="keyword">end</span></div><div class="line">		<span class="string">"<span class="subst">#&#123;name&#125;</span> got a <span class="subst">#&#123;number&#125;</span>"</span></div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>这个程序会执行出无限循环最终崩溃的结果，为什么会这样呢？</p>
<p>number在循环体外使用了，这时候Ruby会认为这是一个方法，然而又找不到这个方法，这时候就会再次触发method_missing方法，如此循环下去，就会不断触发，最终导致崩溃。</p>
<p>这就是幽灵方法的第一个陷阱：在method_missing中的未定义方法会导致无限循环直至崩溃。</p>
<h3 id="白板类"><a href="#白板类" class="headerlink" title="白板类"></a>白板类</h3><p>幽灵方法的另一个陷阱在于：它只有在方法找不到的时候才会被调用，所以假如祖先类或者自己后来增加了这个方法，那么就不会触发method_missing，也就会导致幽灵方法失效。</p>
<p>为了解决这个问题，Ruby提供了白板类BasicObject，它只有很少的几个实例方法:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">p BasicObject.instance_methods</div><div class="line"><span class="comment">#=&gt; [:==, :equal?, :!, :!=, :instance_eval, :instance_exec, :__send__, :__id__]</span></div></pre></td></tr></table></figure>
<p>如果需要白板类，可以直接从BasicObject继承。</p>
<p>在某些情况下可能需要自己决定删除什么方法，这时候可以使用Module#undef_method或者Module#remove_method，前者会删除包括继承而来的所有方法，而后者只会删除接收者自己的方法，而保留继承的方法。</p>
<p>现在，我们也许应该让Computer继承BasicObject了：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span>&lt;BasicObject</span></div><div class="line">  <span class="comment"># ... codes</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>大多数情况下，幽灵方法都不如动态方法来得好，因为它并不是真正的方法，而只是类似异常的一个功能，使用它会导致诸如难以调试、方法被定义等问题。在能使用动态方法完成需求的场景下，我们都应该优先考虑动态方法而不是幽灵方法。当然，也有很多情况下不得不使用幽灵方法，那时候就是幽灵方法大显神威挥起它的镰刀的时候啦~~</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2015-10-24</span><i class="fa fa-tag"></i><a href="/tags/Ruby/" title="Ruby" class="tag">Ruby </a></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://www.shenjianan.net/2015/10/24/Ruby元编程-Week-2/,沈小黑的菜园,Ruby元编程 星期二,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2015/10/26/Ruby元编程-Week-3/" title="Ruby元编程 星期三" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2015/10/24/Ruby元编程-Week-1/" title="Ruby元编程 星期一" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>