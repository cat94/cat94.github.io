<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ben Wong,wenbinben@gmail.com"><title>《HBase实战》随笔——数据操作 · 沈小黑的菜园</title><meta name="description" content="工具的学问总是流于表面，工具内部的艰深又鲜能触及。在eBay实习期间，难免使用到HBase，再加上下季度可能会有这方面的工作，所以看看《HBase实战》学习一下HBase。
对于Hadoop、Yarn、HDFS、HBase这些工具，我都还是个彻彻底底的门外汉。笔记不追求记录下方方面面，只求将涉及工作"><meta name="keywords" content="Hexo,HTML,Ben,CSS,安卓,android,Linux,linuxdeepin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">沈小黑的菜园</a></h3><div class="description"><p>Nothing lasts forever.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/Ben_wenbin"><i class="fa fa-twitter"></i></a></li><li><a href="http://instagram.com/hwbinbenben"><i class="fa fa-instagram"></i></a></li><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/ben0036"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai</a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="https://secure.gravatar.com/avatar/e71df8021446fe9759a9928b1dd5c28d?s=180&amp;r=G&amp;d="></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>《HBase实战》随笔——数据操作</a></h3></div><div class="post-content"><p>工具的学问总是流于表面，工具内部的艰深又鲜能触及。在eBay实习期间，难免使用到HBase，再加上下季度可能会有这方面的工作，所以看看《HBase实战》学习一下HBase。</p>
<p>对于Hadoop、Yarn、HDFS、HBase这些工具，我都还是个彻彻底底的门外汉。笔记不追求记录下方方面面，只求将涉及工作机制的话题进行归纳，本质还是读书笔记，可能还会根据官网上的文档进一步研究完善。</p>
<a id="more"></a>
<h1 id="HBase写机制"><a href="#HBase写机制" class="headerlink" title="HBase写机制"></a>HBase写机制</h1><p>在HBase中新增或者修改行，在默认情况下，会写到两个地方：预写式日志(write-ahead log,WAL,也叫HLog)和MemStore，来保证数据的持久化。只有当两个地方的变化信息都写入并确认之后，才可以认为写动作完成了。</p>
<p>MemStore是内存里的写入缓存区，HBase中写入的数据在这里填满之后会存储到硬盘，生成一个HFile。HFile是HBase使用的底层存储格式，对应于列族，一个列族可能会有多个HFile。在集群的每个节点上，每个族列都有一个MemStore。</p>
<p>如果MemStore在中途崩溃，那么内存中的数据就会丢失。HBase的方法就是在写动作完成之前先写入WAL。HBase集群中<b>每台服务器</b>(一个RegionServer只有一个WAL，所以和MemStore不是一个粒度的。考虑的是追加单个日志可以提高记录效率，减少寻道。缺点是恢复的时候需要拆分)维护一个WAL来记录发生的变化。直到WAL写入成功之后，动作才算成功。如果崩溃，没有从MemStore中写到HFile的数据就会通过WAL自动恢复。</p>
<p>所以客户端在写的过程中不会和底层的HFile直接交互，而是通过MemStore和WAL的定期写入来完成交互。</p>
<img title="HBase写机制" src="http://7xltls.com1.z0.glb.clouddn.com/images/big_data/hbase/hbase实战随笔_数据操作/HBase_write_procedure.jpg">
<h1 id="HBase读机制"><a href="#HBase读机制" class="headerlink" title="HBase读机制"></a>HBase读机制</h1><p>快速访问数据的两大法宝就是：<b>数据有序</b>和<b>内存访问</b>。HBase的读动作必须综合硬盘上的HFile和内存中的MemeStore数据。HBase使用一种叫做BlockCache的LRU(最近最少使用算法)缓存，和MemStore在同一个JVM堆中。跟MemStore一样，每个列族都有自己的BlockCache。</p>
<p>Block是HBase从硬盘完成一次读取的数据单位，HFile物理存放形式是一个Block的序列再加上这些Block的索引。所以从HBase读取一个Block需要先在索引上查找一次然后再在硬盘中读出。Block是建立索引和读取数据的最小单位，默认大小是64KB(如果调小Block大小，会让查询更加细粒度，但是不可避免的也会增大索引)。</p>
<p>从HBase读取一行，首先会检查MemStore中等待修改的队列，然后检查BlockCache，看包含该行的Block是否最近被访问过，如果BlockingCache没有缓存，最后才会访问对应的HFile。</p>
<img title="HBase写机制" src="http://7xltls.com1.z0.glb.clouddn.com/images/big_data/hbase/hbase实战随笔_数据操作/HBase_read_procedure.jpg">
<h1 id="HBase的后台合并"><a href="#HBase的后台合并" class="headerlink" title="HBase的后台合并"></a>HBase的后台合并</h1><p>HBase的Delete命令并不立即删除内容，而是针对那个内容写入一条新的删除标记，这个删除标记叫做“墓碑”(tombstone)。被标记的内容不能在Get和Scan操作中返回结果。作为磁盘文件，HFile只有在执行一次<b>大合并</b>的时候才会处理墓碑记录，被删除记录占用的空间才会被释放。“墓碑”记录并不一定和被删除的记录在同一个HFile里面，HFile在非合并的时候是不会被改变的。</p>
<p>合并分为<b>大合并</b>和<b>小合并</b>，小合并把小HFile合并成一个大HFile，这样可以避免在读一行的时候引用过多文件，提升读性能。在执行合并的时候，HBase读出已有的多个HFile内容，并把记录写入一个新文件。然后把新文件设置为激活状态，删除所有老文件，它会占用大量的磁盘和网络IO，但相比大合并还是轻量级的，可以频繁发生。</p>
<img title="HBase合并" src="http://7xltls.com1.z0.glb.clouddn.com/images/big_data/hbase/hbase实战随笔_数据操作/HBase_combine.jpg">
<p>大合并处理给定region的一个列族的所有HFile，将这个列族所有的HFile合并成一个文件。这个动作相当耗费资源，可以从Shell中手工触发大合并，这也是清理被删除记录的唯一机会。</p>
<p>从合并的操作可以看出，HBase其实不适合存储经常删改的数据，因为删除的记录在大合并前依旧占用空间，而大合并又十分耗费资源。</p>
<h1 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h1><h2 id="半结构化数据模型的影响"><a href="#半结构化数据模型的影响" class="headerlink" title="半结构化数据模型的影响"></a>半结构化数据模型的影响</h2><p>HBase在设计上不像关系型数据库(比如MySQL)一样有严格的格式要求，每个数据记录可能包含不同的列和不同的大小。事物都有它的两面性，结构化也是这样。一方面，结构化的数据都有很强的规律性，因此关系型数据可以利用这样的规律优化存储的格式和结构，而HBase就无法做到这么强的存储优化，这要求优化HBase数据系统时必须深入理解逻辑模型和物理模型。而另一方面，半结构化数据结构方便对数据结构进行扩展，松散的结构也更适合于物理上分散存放(比如以列族为单位进行物理分散存储)。</p>
<h2 id="有序的映射集合"><a href="#有序的映射集合" class="headerlink" title="有序的映射集合"></a>有序的映射集合</h2><p>在HBase中，每个嵌套内部的键排列都是有序的。在下图中的”email”在”name”前面，时间版本的值也是有序的(时间版本是倒序的，最近的在最上面)。</p>
<img title="HBase合并" src="http://7xltls.com1.z0.glb.clouddn.com/images/big_data/hbase/hbase实战随笔_数据操作/有序映射的映射.jpg">
<h2 id="面向列族"><a href="#面向列族" class="headerlink" title="面向列族"></a>面向列族</h2><p>HBase中的列按照列族分组，每个列族在硬盘中有自己的HFile集合，在合并的时候，每个列族也是单独管理的(记得上文的MemStore和BlockCache吗)。</p>
<p>HBase的记录是按照键值对存储在HFile里的，而HFile是一个二进制文件，一行中一个列族可能存放在很多个HFile中，但是保证是在同一个物理空间的。这样的设计保证了读取时可以只读取自己需要的列族，有利于快速读取，其他列族的增长也不会对本列族的性能带来影响。</p>
<img title="HBase合并" src="http://7xltls.com1.z0.glb.clouddn.com/images/big_data/hbase/hbase实战随笔_数据操作/region内部数据模型.jpg"></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-01-07</span><i class="fa fa-tag"></i><a href="/tags/大数据/" title="大数据" class="tag">大数据 </a><a href="/tags/HBase/" title="HBase" class="tag">HBase </a></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://www.shenjianan.net/2016/01/07/《HBase实战》随笔——数据操作/,沈小黑的菜园,《HBase实战》随笔——数据操作,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2016/01/11/BigTable论文阅读-个人翻译/" title="BigTable论文阅读&amp;个人翻译" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2015/12/29/Hadoop笔记/" title="HDFS起步笔记" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>