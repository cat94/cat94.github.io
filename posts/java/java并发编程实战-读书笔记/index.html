<!DOCTYPE html>
<html lang="zh-cmn-Hans">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>
Java并发编程实战 读书笔记
</title>

    
  <link href="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/avatars/totoro3.jpeg?x-oss-process=style/icon" rel="shortcut icon" type="image/x-icon" />



  
  <meta name="author" content="Shen Jianan" />
  <meta name="description" content="Java并发编程实战——一本近300页的薄书，但是却延宕了相当长一段时间。中间上公开课，转职……注意力完全不在这本书上，到现在也只看了一半。想来应该做个笔记，就先把之前看的一半笔记写上，一并算是复习了。
" />



<meta name="generator" content="Hugo 0.68.3" />

<link rel="canonical" href="http://www.shenjianan.top/posts/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" />


<meta property="og:title" content="Java并发编程实战 读书笔记" />
<meta property="og:description" content="Java并发编程实战——一本近300页的薄书，但是却延宕了相当长一段时间。中间上公开课，转职……注意力完全不在这本书上，到现在也只看了一半。想来应该做个笔记，就先把之前看的一半笔记写上，一并算是复习了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.shenjianan.top/posts/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" />
<meta property="article:published_time" content="2015-11-29T22:28:19+00:00" />
<meta property="article:modified_time" content="2015-11-29T22:28:19+00:00" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Java并发编程实战 读书笔记"/>
<meta name="twitter:description" content="Java并发编程实战——一本近300页的薄书，但是却延宕了相当长一段时间。中间上公开课，转职……注意力完全不在这本书上，到现在也只看了一半。想来应该做个笔记，就先把之前看的一半笔记写上，一并算是复习了。"/>


<link rel="stylesheet" href="/css/github-markdown.css" />
<link rel="stylesheet" href="/css/semantic.min.css" />
<link rel="stylesheet" href="/css/site.css" />





  </head>

  
  <body style="background-image: url(https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/bg/mountains-covered-in-snow-mid.jpg);">
  
    <div class="flip-container">
      <div class="flipper">
        <section class="front">
          
<nav class="ui secondary menu dream-menu">

  <div class="item">
    <i class="large link bullseye icon dream-flip-toggle" title="Flip it!"></i>
  </div>
  <div class="item">
    <i class="large link home icon" title="Home" onclick="window.location.href = 'http:\/\/www.shenjianan.top\/'"></i>
  </div>
  <div class="item">
    <i class="large link icon theme-switch" onclick="themeSwitch()"></i>
  </div>
</nav>

          
<div class="ui centered relaxed grid dream-grid">
  <div class="sixteen wide mobile sixteen wide tablet twelve wide computer column markdown-body dream-single">

    <section class="ui top attached segment" id="dream-save-post-as-img">
      <header style="margin-top: 0 !important;">
        <h2 class="ui header">
          Java并发编程实战 读书笔记
          <div class="sub header">@ Shen Jianan · Sunday, Nov 29, 2015 · 10 minute read · Update at Nov 29, 2015</div>
        </h2>
      </header>
      <article style="margin-top: 2rem;"><p>Java并发编程实战——一本近300页的薄书，但是却延宕了相当长一段时间。中间上公开课，转职……注意力完全不在这本书上，到现在也只看了一半。想来应该做个笔记，就先把之前看的一半笔记写上，一并算是复习了。</p>
<h1 id="对象的共享">对象的共享</h1>
<h2 id="可见性">可见性</h2>
<p>所谓可见性就是变量在被访问的时候一定是最新的值。下面的程序展示了一种不满足可见性的情况：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NoVisibility</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> number<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> ready <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReaderThread</span> <span style="color:#66d9ef">extends</span> Thread<span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>ready<span style="color:#f92672">)</span>
                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">yield</span><span style="color:#f92672">();</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>number<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">new</span> ReaderThread<span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>

        ready <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        number <span style="color:#f92672">=</span> 42<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这样一个简单的程序，可能会死循环或输出0，因为编译器、处理器等会对操作的顺序进行调整，称为“重排序”，因为在这里主线程和readerThread没有共享数据。</p>
<h3 id="最低安全性与64位操作">最低安全性与64位操作</h3>
<p>虽然在没有同步的情况下会读取到失效值，但至少是某个线程设置的值而不是随机数，这被称为最低安全性。上面的NoVisibility就满足最低安全性，number只可能是0或者42。但是并不是所有情况都能满足最低安全性。当操作64位数的时候，比如非volatile的long和double，就不满足最低安全性，因为JVM允许将它们分为两个32位操作，而这两个32位操作如果在不同线程中执行，那么很可能只读到一半的32位内容。</p>
<p>加锁的含义不仅仅局限于互斥行为，还包括内存可见性。加锁机制确保了本线程的写入值在其他线程是可见的，而不是让其他线程读到了失效值。</p>
<h3 id="volatile变量">volatile变量</h3>
<p>加锁机制能够保证变量的可见性，但是开销却难免比较大，而volatile是稍弱的同步机制，确保将变量的更新操作通知到其他线程。</p>
<p>可见性问题的本质就是编译器为了优化而进行指令的重排序和寄存器缓存，当声明为volatile之后，编译器与运行时不会将该变量上的操作与其他内存操作一起重排序。volatile变量不会被缓存到寄存器上，所以读取volatile类型的变量时总会返回最新写入的值。</p>
<h3 id="volatile和加锁在操作原子性上的差异">volatile和加锁在操作原子性上的差异</h3>
<p>访问volatile变量不会执行加锁操作，所以不会使线程阻塞，也就不能保证原子性。而加锁操作既可以保证可见性又可以保证原子性。因此，我写了一小段自增1000次到10000的多线程代码，比较volatile和内置锁不同的表现。</p>
<h4 id="volatile">volatile</h4>
<p><img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/volatile%E5%8E%9F%E5%AD%90%E6%80%A7%E8%A1%A8%E7%8E%B0.png?x-oss-process=style/compress" alt="volatile原子性表现"></p>
<p>最后看到的值没有到达10000(出现频率大概在10%)，说明没有做到原子写(写操作不能被影响)。</p>
<h4 id="内置锁synchronized">内置锁(synchronized)</h4>
<p><img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/%E5%8A%A0%E9%94%81%E5%8E%9F%E5%AD%90%E6%80%A7%E8%A1%A8%E7%8E%B0.png?x-oss-process=style/compress" alt="加锁原子性表现"></p>
<p>最后看到的值都到达了10000，说明写操作是原子的</p>
<h3 id="使用volatile的条件">使用volatile的条件</h3>
<p>根据volatile只保证可见性而不保证原子性的特征，可以在以下的情况下替代加锁操作，毕竟加锁操作的开销很大。</p>
<ol>
<li>写入值不依赖值的当前状态，或者确保只有单个线程更新变量的值</li>
<li>该变量不会与其他状态变量一起纳入不变性条件中</li>
<li>在访问时不需要加锁</li>
</ol>
<h2 id="线程封闭的方法">线程封闭的方法</h2>
<p>线程封闭是指仅在单个线程中访问数据的技巧，这样可以避免共享数据而需要的同步。</p>
<h3 id="ad-hoc线程封闭">Ad-hoc线程封闭</h3>
<p>自己专门设计一个程序来维护线程的封闭性，Ad hoc是拉丁文常用短语中的一个短语。这个短语的意思是“特设的、特定目的的（地）、即席的、临时的、将就的、专案的”。这个短语通常用来形容一些特殊的、不能用于其它方面的的，为一个特定的问题、任务而专门设定的解决方案。比如开发一个只有单个线程修改volatile的程序。</p>
<h3 id="栈封闭">栈封闭</h3>
<p>栈封闭将变量封闭在方法体中，只能通过局部变量才能访问到对象。</p>
<p>对于基本类型，由于没有引用，无论如何都不会破坏栈封闭性。对于对象，要注意不要将需要封闭的对象逸出，被外部线程访问到。这样的话，对象位于执行线程的栈中，其他线程无法访问这个栈。</p>
<h3 id="threadlocal类">ThreadLocal类</h3>
<p>ThreadLocal是更规范的一种做法，它能够使线程中的某个值与保存值的对象关联起来。</p>
<p>ThreadLocal提供了get与set等访问接口或方法，这些方法为每个使用该变量的线程都存有一份独立的备份。通常ThreadLocal用于防止对可变的单实例变量或全局变量进行共享。当第一次使用get时，ThreadLocal通过initalValue获得初始值</p>
<h3 id="threadlocal与实例变量的区别">ThreadLocal与实例变量的区别</h3>
<p>实例变量为对象实例私有，在java虚拟机的堆中分配，如果在系统中只存在一个此对象的实例，在多线程环境下，就像静态变量那样，被某个线程修改后，其他线程对修改均可见，故线程非安全；如果每个线程执行都是在不同的对象中，那对象与对象之间的实例变量的修改将互不影响，所以线程安全。 </p>
<p>下例中，使用ThreadLocal和实例变量的String分别创建20个线程，每个线程报告自己所看到的编号。这里使用实例变量的线程就会产生看到其他线程变量的情况，而ThreadLocal就不会产生这样的情况。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadWithOutLocal</span> <span style="color:#66d9ef">extends</span> Thread<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String strHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">();</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> value<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ThreadWithOutLocal</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> _i<span style="color:#f92672">){</span>
        value <span style="color:#f92672">=</span> _i<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">(){</span>
        strHolder<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value &#34;</span><span style="color:#f92672">+</span>value<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>3<span style="color:#f92672">;</span>i<span style="color:#f92672">++)</span>
           System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;thread &#34;</span><span style="color:#f92672">+</span>value<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; saw &#34;</span><span style="color:#f92672">+</span>strHolder<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String args<span style="color:#f92672">[]){</span>
    ThreadWithOutLocal<span style="color:#f92672">[]</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadWithOutLocal<span style="color:#f92672">[</span>20<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>20<span style="color:#f92672">;</span>i<span style="color:#f92672">++)</span>
        list<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadWithOutLocal<span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>20<span style="color:#f92672">;</span>i<span style="color:#f92672">++)</span>
        list<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这里的代码输出就可能会产生下图的情况：</p>
<p><img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/%E9%9D%99%E6%80%81%E5%AE%9E%E4%BE%8B%E5%8F%98%E9%87%8F%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E8%AE%BF%E9%97%AE%E6%B7%B7%E4%B9%B1.png?x-oss-process=style/compress" alt="静态实例变量多线程的访问混乱"></p>
<p>这里是因为static在所有类的实例中都可以访问，但除了static，就算是私有变量也有可能会因为使用同一个对象创建多个线程而产生问题：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadLocalTest</span> <span style="color:#f92672">{</span>  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
        Runnable accumelatora <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Accumulatort<span style="color:#f92672">();</span>  
        Thread threada <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>accumelatora<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ThreadA&#34;</span><span style="color:#f92672">);</span>  
        Thread threadb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>accumelatora<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ThreadB&#34;</span><span style="color:#f92672">);</span>  
        threada<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>  
        threadb<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>  
    <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span>  
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Accumulatort</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>  
    <span style="color:#75715e">// 实例变量  
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> locals <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>  
    <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;unchecked&#34;</span><span style="color:#f92672">)</span>  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;=</span> 10<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>  
            locals <span style="color:#f92672">+=</span> 1<span style="color:#f92672">;</span>  
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>  
                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>1000<span style="color:#f92672">);</span>  
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
            <span style="color:#f92672">}</span>  
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;--&gt;&#34;</span> <span style="color:#f92672">+</span> locals<span style="color:#f92672">);</span>  
        <span style="color:#f92672">}</span>  
    <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span>  
</code></pre></div><p>这里的locals变量会产生大于10的结果，这可能就不是开发者所期望的效果了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadWithLocal</span> <span style="color:#66d9ef">extends</span> Thread<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ThreadLocal<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> strHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;();</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> value<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ThreadWithLocal</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> _i<span style="color:#f92672">){</span>
        value <span style="color:#f92672">=</span> _i<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">(){</span>
        strHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value &#34;</span><span style="color:#f92672">+</span>value<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>3<span style="color:#f92672">;</span>i<span style="color:#f92672">++)</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;thread &#34;</span><span style="color:#f92672">+</span>value<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; saw &#34;</span><span style="color:#f92672">+</span>strHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String args<span style="color:#f92672">[]){</span>
    ThreadWithLocal<span style="color:#f92672">[]</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadWithLocal<span style="color:#f92672">[</span>20<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>20<span style="color:#f92672">;</span>i<span style="color:#f92672">++)</span>
        list<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadWithLocal<span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>20<span style="color:#f92672">;</span>i<span style="color:#f92672">++)</span>
        list<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ThreadLocal以线程为单位，而不是以实例为单位，所以就杜绝了产生上面两种问题的可能性：</p>
<p><img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/ThreadLocal%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%AE%BF%E9%97%AE%E6%AD%A3%E5%B8%B8.png?x-oss-process=style/compress" alt="ThreadLocal多线程访问正常"></p>
<h1 id="基础构建模块">基础构建模块</h1>
<h2 id="同步容器类">同步容器类</h2>
<p>同步容器类包括Vector和Hashtable，它们会将所有对容器状态访问的操作都串行化，所以会严重降低并发性。在迭代的时候，也会对容器进行加锁，如果不想要受到这个影响的话，可以克隆容器并且在副本上进行迭代。</p>
<h2 id="并发容器">并发容器</h2>
<p>并发容器针对多线程并发访问设计，比如ConcurrentHashMap，CopyOnWriteArrayList等。同步容器类在执行每个操作的时候都会持有一个锁，而并发容器使用粒度更细的加锁机制——分段锁。所以允许更多线程同时进行操作。</p>
<h2 id="同步工具类">同步工具类</h2>
<h3 id="闭锁">闭锁</h3>
<p>闭锁可以用来确保某些活动直到其他活动都完成后才继续执行。CountDownLatch是一种灵活的闭锁实现，await会等待计数到达零。</p>
<blockquote>
<p>CountDownLatch是一次性对象， 只有CountDown而没有CountUp方法</p>
</blockquote>
<p>如下的代码中，startGate用于协调所有的线程同时开始，endGate用于标记所有的线程同时结束。只有在startGate降到0，线程才会开始，在endGate降到0，才会结束并得到endTime。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestCountDownLatch</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String args<span style="color:#f92672">[]){</span>
        TestCountDownLatch test <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TestCountDownLatch<span style="color:#f92672">();</span>
        test<span style="color:#f92672">.</span><span style="color:#a6e22e">test</span><span style="color:#f92672">(</span>100<span style="color:#f92672">,</span><span style="color:#66d9ef">new</span> MyTask<span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyTask</span> <span style="color:#66d9ef">implements</span> Runnable<span style="color:#f92672">{</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> j<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>100000<span style="color:#f92672">;++</span>i<span style="color:#f92672">){</span>
                <span style="color:#f92672">++</span>j<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> nThread<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Runnable task<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">final</span> CountDownLatch startGate <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CountDownLatch<span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> CountDownLatch endGate <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CountDownLatch<span style="color:#f92672">(</span>nThread<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>nThread<span style="color:#f92672">;++</span>i<span style="color:#f92672">){</span>
            Thread th <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                        startGate<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>

                        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                            task<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
                        <span style="color:#f92672">}</span><span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                            endGate<span style="color:#f92672">.</span><span style="color:#a6e22e">countDown</span><span style="color:#f92672">();</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">};</span>
            th<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">long</span> startTime <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
        startGate<span style="color:#f92672">.</span><span style="color:#a6e22e">countDown</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            endGate<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">long</span> endTime <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;the time is &#34;</span><span style="color:#f92672">+(</span>endTime<span style="color:#f92672">-</span>startTime<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

</code></pre></div><h3 id="futuretask">FutureTask</h3>
<p>FutureTask也可以用作闭锁。表示的计算是通过Callable来实现的，表示一种抽象的可生成结果的Runnable，处于等待、运行中和运行完成这三种状态中的一种。（运行完成也可能是运行失败或被中断等）</p>
<p>Future.get的行为是阻塞的，如果任务没有完成会一直阻塞。确保了结果的传递是安全发布的。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestFutureTask</span> <span style="color:#f92672">{</span>

<span style="color:#75715e">//    package the FutureTask with callable task
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> FutureTask<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FutureTask<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;(</span><span style="color:#66d9ef">new</span> Callable<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">call</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> pre<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> after<span style="color:#f92672">=</span>1<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>

            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>10000<span style="color:#f92672">;++</span>i<span style="color:#f92672">){</span>
                result <span style="color:#f92672">=</span> after<span style="color:#f92672">+</span>pre<span style="color:#f92672">;</span>
                pre <span style="color:#f92672">=</span> after<span style="color:#f92672">;</span>
                after <span style="color:#f92672">=</span> result<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Thread thread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>future<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test</span><span style="color:#f92672">(){</span>
        thread<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;calc result is &#34;</span><span style="color:#f92672">+</span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ExecutionException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String args<span style="color:#f92672">[]){</span>
        TestFutureTask testFutureTask <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TestFutureTask<span style="color:#f92672">();</span>
        testFutureTask<span style="color:#f92672">.</span><span style="color:#a6e22e">test</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="信号量semaphore">信号量Semaphore</h3>
<p>信号量管理着一组虚拟的许可，release是释放一个信号量，acquire是申请一个信号量。如果没有获得许可，acquire将阻塞直到有许可。</p>
<p>Semaphore并不受限于构造函数中的许可数量。当release的时候，总会新增一个许可。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestSemaphore</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Semaphore sem <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Semaphore<span style="color:#f92672">(</span>5<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyRunnable</span> <span style="color:#66d9ef">implements</span> Runnable<span style="color:#f92672">{</span>
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> i<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setI</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">){</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> i<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                sem<span style="color:#f92672">.</span><span style="color:#a6e22e">acquire</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;current i: &#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;   start time: &#34;</span> <span style="color:#f92672">+</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">());</span>

            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>1000<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;current i:&#34;</span><span style="color:#f92672">+</span>i<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;   release time:&#34;</span><span style="color:#f92672">+</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">());</span>
            sem<span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">();</span>

        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>


    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startTest</span><span style="color:#f92672">(){</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>10<span style="color:#f92672">;</span>i<span style="color:#f92672">++){</span>
            MyRunnable myRunnable <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MyRunnable<span style="color:#f92672">();</span>
            myRunnable<span style="color:#f92672">.</span><span style="color:#a6e22e">setI</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>

            Thread th <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>myRunnable<span style="color:#f92672">);</span>

            th<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">){</span>
        TestSemaphore test <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TestSemaphore<span style="color:#f92672">();</span>
        sem<span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">();</span>          <span style="color:#75715e">//additional release can make the semaphore to be more than 5
</span><span style="color:#75715e"></span>        test<span style="color:#f92672">.</span><span style="color:#a6e22e">startTest</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这里的代码在main函数中额外release了一下，则可以看到前6个线程都直接申请到了信号量，而后四个则只能等其他线程释放信号量之后才得到信号量</p>
<p><img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C.png?x-oss-process=style/compress" alt="信号量实验结果"></p>
<h3 id="栅栏">栅栏</h3>
<p>栅栏类似于闭锁，能阻塞一组线程直到某个事件发生。区别在于：闭锁的准许信号可以来自外部，也可以来自其他线程，只要能让CountDownLntch的信号到0即可，设置CountDownLntch的地方不一定在await；而栅栏是所有线程之间互相等待，直到所有线程都到达某一个栅栏。闭锁用于等待事件，而栅栏用于等待其他线程。</p>
<p>闭锁一旦到达终止状态，就不能被重置。而栅栏在所有线程都到达后，所有线程都会被放行，而栅栏将会被重置。如果超时或被中断，会抛出BrokenBarrierException。成功地通过栅栏之后，await将会为每个线程返回唯一的到达索引号。</p>
<p>当一个计算的下一步需要其他并行的计算结果的状态时，经常就需要栅栏。</p>
<h4 id="cyclicbarrier">CyclicBarrier</h4>
<p>CyclicBarrier允许将一个Runnable传递给构造函数，当成功通过栅栏时会在一个子任务线程中自动执行这个Runnable。CyclicBarrier可以使一定数量的参与方反复地汇集在栅栏处，这在并行迭代算法中非常有用——通常将一个问题拆分成一系列相互独立的子问题。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestCyclicBarrier</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 5<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> currentValue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[</span>count<span style="color:#f92672">*</span>2<span style="color:#f92672">];</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> CyclicBarrier barrier <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CyclicBarrier<span style="color:#f92672">(</span>count<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//第一个到达的线程会运行这一行代码
</span><span style="color:#75715e"></span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;get the barrier!&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>


    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyTask</span> <span style="color:#66d9ef">implements</span> Runnable<span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> currentI<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">int</span> currentBase<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">int</span> nextBase<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MyTask</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">){</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">currentI</span> <span style="color:#f92672">=</span> i<span style="color:#f92672">;</span>
            currentBase <span style="color:#f92672">=</span> currentI<span style="color:#f92672">;</span>
            nextBase <span style="color:#f92672">=</span> currentI<span style="color:#f92672">+</span>count<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                currentValue<span style="color:#f92672">[</span>currentBase<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

                <span style="color:#66d9ef">int</span> multi <span style="color:#f92672">=</span> currentBase<span style="color:#f92672">/</span>count<span style="color:#f92672">;</span>

                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span>
                    currentValue<span style="color:#f92672">[</span>currentBase<span style="color:#f92672">]</span> <span style="color:#f92672">+=</span> currentValue<span style="color:#f92672">[(</span>1<span style="color:#f92672">-</span>multi<span style="color:#f92672">)</span> <span style="color:#f92672">*</span> count <span style="color:#f92672">+</span> i<span style="color:#f92672">];</span>

                <span style="color:#66d9ef">int</span> tmp <span style="color:#f92672">=</span> currentBase<span style="color:#f92672">;</span>
                currentBase <span style="color:#f92672">=</span> nextBase<span style="color:#f92672">;</span>
                nextBase <span style="color:#f92672">=</span> tmp<span style="color:#f92672">;</span>

                <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> barrier<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
        
                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>index<span style="color:#f92672">);</span>

                <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">){</span>
                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>BrokenBarrierException e<span style="color:#f92672">){</span>
                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String args<span style="color:#f92672">[]){</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>count<span style="color:#f92672">*</span>2<span style="color:#f92672">;++</span>i<span style="color:#f92672">){</span>
            currentValue<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>count<span style="color:#f92672">;++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            MyTask myTask <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MyTask<span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
            Thread th <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>myTask<span style="color:#f92672">);</span>
            th<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/CyclicBarrier%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C.png?x-oss-process=style/compress" alt="CyclicBarrier实验结果"></p>
<h3 id="构建高性能可伸缩结果缓存的实践">构建高性能可伸缩结果缓存的实践</h3>
<p>假设条件：有一个非常耗时的计算操作，希望将计算结果存入一个Map来避免重复计算</p>
<p>使用ConcurrentHashMap依然可能会导致重复计算：如果发现某一个key没有被计算过，但其实另一个线程正在进行耗时的计算，计算后就会把这个键put进去，那依然会进行重复计算。</p>
<h4 id="优化1">优化1</h4>
<p>使用FurureTask来进行计算，存储Map内容为ConcurrentHashMap&lt;key,Future<result>&gt;，这样，当一个线程正在计算result时，HashMap中已经存有Key,即使没有计算完成也会阻塞地进行读取。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FutureCachedPool</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">static</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span>Future<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;&gt;</span> pool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> Future<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;&gt;();</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Integer <span style="color:#a6e22e">getResult</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> key<span style="color:#f92672">){</span>
        Future<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result<span style="color:#f92672">==</span><span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
            Callable<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> calcuTask <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Callable<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">call</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span> ComplexCalculation<span style="color:#f92672">.</span><span style="color:#a6e22e">complexCalculation</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">};</span>
            FutureTask<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> calcResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FutureTask<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;(</span>calcuTask<span style="color:#f92672">);</span>
            result <span style="color:#f92672">=</span> calcResult<span style="color:#f92672">;</span>
            pool<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>key<span style="color:#f92672">,</span>calcResult<span style="color:#f92672">);</span>
            calcResult<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ExecutionException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="存留问题">存留问题</h4>
<p>依然可能导致进行重复计算：判断是否存在此key和put一个key之间的空隙，依然可能导致脏读而重复计算:</p>
<p><img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/%E6%9E%84%E9%80%A0%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%93%E5%AD%98_%E6%A3%80%E6%9F%A5%E4%B8%8Eput%E4%B9%8B%E9%97%B4%E7%9A%84%E9%97%B4%E9%9A%99.png?x-oss-process=style/compress" alt="构造高性能缓存_检查与put之间的间隙"></p>
<p>执行结果中些许的重复计算：</p>
<p><img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/%E6%9E%84%E9%80%A0%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%93%E5%AD%98_%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C%E4%B8%AD%E4%BA%9B%E8%AE%B8%E7%9A%84%E9%87%8D%E5%A4%8D%E8%AE%A1%E7%AE%97.png?x-oss-process=style/compress" alt="构造高性能缓存_执行结果中些许的重复计算"></p>
<h4 id="优化2">优化2</h4>
<p>使用putIfAbsent来解决可能重复put的问题，如果该方法返回null，说明之前没有已经插入的内容，则可以开始计算。</p>
<p>优化后的代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BetterFutureCachedPool</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">static</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span>Future<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;&gt;</span> pool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> Future<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;&gt;();</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Integer <span style="color:#a6e22e">getResult</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> key<span style="color:#f92672">){</span>
        Future<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result<span style="color:#f92672">==</span><span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
            Callable<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> calcuTask <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Callable<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">call</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span> ComplexCalculation<span style="color:#f92672">.</span><span style="color:#a6e22e">complexCalculation</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">};</span>
            FutureTask<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> calcResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FutureTask<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;(</span>calcuTask<span style="color:#f92672">);</span>

<span style="color:#75715e">//            only calculates when there is no conflict
</span><span style="color:#75715e"></span>            result <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>key<span style="color:#f92672">,</span>calcResult<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result<span style="color:#f92672">==</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                result <span style="color:#f92672">=</span> calcResult<span style="color:#f92672">;</span>
                calcResult<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ExecutionException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>计算情况如下，可以发现没有如上面那样的重复计算了：
<a href="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java">https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/images/notes/java</a>并发编程实战/构造高性能缓存_没有重复计算.png title:构造高性能缓存_没有重复计算</p>
<h4 id="其他问题">其他问题</h4>
<p>Future可能会导致缓存污染的问题：如果Future计算失败了或超时了，在Map中依然存有此Future，所以需要在超时或失败之后将此Future从Map中移除</p></article>
    </section>

    <footer class="ui attached segment dream-tags">
      
        
          <a class="ui label" href="/tags/java" title="Java">Java</a>
        
          <a class="ui label" href="/tags/%E7%AC%94%E8%AE%B0" title="笔记">笔记</a>
        
      
      <div
        class="ui label"
        style="float: right; background: #1b1c1d !important; cursor: pointer;"
        onclick="savePostAsImg()">
        <i class="save icon"></i> Save as image
      </div>
    </footer>

    
      <footer class="ui attached segment">
        <strong>欢迎通过<a href="mailto:shen_jianan@foxmail.com">邮箱</a>(shen_jianan@foxmail.com)探讨问题</strong> <br/><br/><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。 <br />
      </footer>
    

    

  </div>
  <div class="sixteen wide mobile sixteen wide tablet four wide computer column">
    <article class="dream-header">
  <section class="ui top attached center aligned segment">
    <div class="ui small circular image">
      
        <img src="https://shenjianan-blog.oss-cn-beijing.aliyuncs.com/avatars/totoro3.jpeg?x-oss-process=style/compress">
      
    </div>

    <h1 class="ui medium header">Shen Jianan&#39;s blog<div class="sub header" style="margin-top: 0.5rem;">Freedom as Autonomy</div>
    </h1>

    <div class="ui horizontal list">
      
      <a class="item" href="/posts">
        <i class="archive icon" title="Archives"></i>
      </a>
      
      <a class="item" href="/tags">
        <i class="tags icon" title="All Tags"></i>
      </a>
      <a class="item" href="/categories">
        <i class="th list icon" title="All Categories"></i>
      </a>
    </div>
  </section>

  
  <section class="ui attached center aligned segment dream-tags">
    
      <a class="ui label" href="/tags/hbase" title="hbase">hbase</a>
    
      <a class="ui label" href="/tags/java" title="java">java</a>
    
      <a class="ui label" href="/tags/redis" title="redis">redis</a>
    
      <a class="ui label" href="/tags/ruby" title="ruby">ruby</a>
    
      <a class="ui label" href="/tags/%E4%B9%A0%E9%A2%98" title="习题">习题</a>
    
      <a class="ui label" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F" title="分布式">分布式</a>
    
      <a class="ui label" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0" title="机器学习">机器学习</a>
    
      <a class="ui label" href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C" title="神经网络">神经网络</a>
    
      <a class="ui label" href="/tags/%E7%AC%94%E8%AE%B0" title="笔记">笔记</a>
    
      <a class="ui label" href="/tags/%E7%AE%97%E6%B3%95" title="算法">算法</a>
    
      <a class="ui label" href="/tags/%E7%AE%97%E6%B3%95%E5%BC%95%E6%93%8E" title="算法引擎">算法引擎</a>
    
      <a class="ui label" href="/tags/%E8%AE%BA%E6%96%87" title="论文">论文</a>
    
  </section>
  

  
  <section class="ui attached segment dream-categories">
    <div class="ui accordion">
      
        <div class="title">
          <i class="dropdown icon"></i>
          <a href="/categories/java" class="item">java</a>
        </div>
        <div class="content">
          <div class="ui list">
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="item">Java并发编程实战 读书笔记</a>
              </div>
            </div>
          
          </div>
        </div>
      
        <div class="title">
          <i class="dropdown icon"></i>
          <a href="/categories/redis" class="item">redis</a>
        </div>
        <div class="content">
          <div class="ui list">
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/redis/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E4%BA%8B%E4%BB%B6/" class="item">Redis设计与实现——事件</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/redis/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0aof%E6%8C%81%E4%B9%85%E5%8C%96/" class="item">Redis设计与实现——AOF持久化</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/redis/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0rdb%E6%8C%81%E4%B9%85%E5%8C%96/" class="item">Redis设计与实现——RDB持久化</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/redis/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%97%E8%A1%A8%E4%B8%8E%E7%BB%93%E6%9E%84%E4%BD%93/" class="item">Redis设计与实现——数据库列表与结构体</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/redis/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0sds%E5%93%88%E5%B8%8C%E8%A1%A8/" class="item">Redis设计与实现——SDS哈希表</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/redis/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0sds%E5%AE%9E%E7%8E%B0%E4%B8%8E%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="item">Redis设计与实现——SDS实现与代码解读</a>
              </div>
            </div>
          
          </div>
        </div>
      
        <div class="title">
          <i class="dropdown icon"></i>
          <a href="/categories/ruby" class="item">ruby</a>
        </div>
        <div class="content">
          <div class="ui list">
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/ruby/ruby%E5%85%83%E7%BC%96%E7%A8%8B-week-5/" class="item">Ruby元编程 星期五</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/ruby/ruby%E5%85%83%E7%BC%96%E7%A8%8B-week-4/" class="item">Ruby元编程 星期四</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/ruby/ruby%E5%85%83%E7%BC%96%E7%A8%8B-week-3/" class="item">Ruby元编程 星期三</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/ruby/ruby%E5%85%83%E7%BC%96%E7%A8%8B-week-2/" class="item">Ruby元编程 星期二</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/ruby/ruby%E5%85%83%E7%BC%96%E7%A8%8B-week-1/" class="item">Ruby元编程 星期一</a>
              </div>
            </div>
          
          </div>
        </div>
      
        <div class="title">
          <i class="dropdown icon"></i>
          <a href="/categories/%E4%B9%A0%E9%A2%98" class="item">习题</a>
        </div>
        <div class="content">
          <div class="ui list">
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/exercises/2020-11-07/" class="item">习题2020-11-07</a>
              </div>
            </div>
          
          </div>
        </div>
      
        <div class="title">
          <i class="dropdown icon"></i>
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F" class="item">分布式</a>
        </div>
        <div class="content">
          <div class="ui list">
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/distributed/raft%E6%A6%82%E8%AE%BA/" class="item">Raft概论</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/distributed/bigtable%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB-%E4%B8%AA%E4%BA%BA%E7%BF%BB%E8%AF%91/" class="item">BigTable论文阅读&amp;个人翻译</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/distributed/hbase%E5%AE%9E%E6%88%98%E9%9A%8F%E7%AC%94%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C/" class="item">《HBase实战》随笔——数据操作</a>
              </div>
            </div>
          
          </div>
        </div>
      
        <div class="title">
          <i class="dropdown icon"></i>
          <a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0" class="item">机器学习</a>
        </div>
        <div class="content">
          <div class="ui list">
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/machinelearning/%E4%BC%98%E5%8C%96%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E8%A1%A8%E7%8E%B0%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/" class="item">优化神经网络表现的几种方法</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/machinelearning/%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E8%83%8C%E5%90%8E%E7%9A%84%E5%9B%9B%E4%B8%AA%E5%9F%BA%E6%9C%AC%E7%AD%89%E5%BC%8F/" class="item">反向传播背后的四个基本等式</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/machinelearning/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="item">神经网络基础知识</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/machinelearning/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-ex6/" class="item">机器学习 ex6</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/machinelearning/%E6%A0%B8%E5%87%BD%E6%95%B0/" class="item">核函数</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/machinelearning/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E8%AE%A1%E7%AE%97%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="item">神经网络反向传播计算过程笔记</a>
              </div>
            </div>
          
          </div>
        </div>
      
        <div class="title">
          <i class="dropdown icon"></i>
          <a href="/categories/%E7%AE%97%E6%B3%95" class="item">算法</a>
        </div>
        <div class="content">
          <div class="ui list">
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/algorithm/%E5%86%8D%E6%8E%A2%E6%8E%92%E5%BA%8F/" class="item">再探排序</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/algorithm/%E4%BA%8C%E5%8F%89%E6%A0%91-%E7%BA%A2%E9%BB%91%E6%A0%91%E5%B0%8F%E7%BB%93/" class="item">简单搜索二叉树&amp;红黑树小结</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/algorithm/%E7%BA%BF%E6%80%A7%E6%97%B6%E9%97%B4%E6%8E%92%E5%BA%8F/" class="item">线性时间排序</a>
              </div>
            </div>
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/algorithm/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E5%B0%8F%E7%BB%93/" class="item">快速排序算法小结</a>
              </div>
            </div>
          
          </div>
        </div>
      
        <div class="title">
          <i class="dropdown icon"></i>
          <a href="/categories/%E7%AE%97%E6%B3%95%E5%BC%95%E6%93%8E" class="item">算法引擎</a>
        </div>
        <div class="content">
          <div class="ui list">
          
            <div class="item">
              <div class="content">
                <a href="http://www.shenjianan.top/posts/algorithmengine/faiss%E5%90%91%E9%87%8F%E5%8F%AC%E5%9B%9E%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E6%9C%80%E8%BF%91%E9%82%BB/" class="item">Faiss向量召回引擎如何做到快速查找最近邻</a>
              </div>
            </div>
          
          </div>
        </div>
      
    </div>
  </section>
  

  <section class="ui attached segment header-socials">
    <nav class="ui secondary menu dream-menu dream-socials">
  
    <div class="item">
      <i class=" mail icon" title="email"></i> 
      <a href="mailto:shen_jianan@foxmail.com">
        shen_jianan@foxmail.com
      </a>
    </div>
  

  

  

  

  

  

  

  
</nav>

  </section>

  <section class="ui bottom attached center aligned segment">
    
      <p>© 2015 - 2020 Shen Jianan的随缘更新</p>
    

    <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/g1eny0ung/hugo-theme-dream" target="_blank">Dream</a>.</p>
  </section>
</article>


  </div>
</div>

        </section>
        <section class="back">
          
<nav class="ui secondary menu dream-menu">

  <div class="item">
    <i class="large link bullseye icon dream-flip-toggle" title="Flip it!"></i>
  </div>
  <div class="item">
    <i class="large link home icon" title="Home" onclick="window.location.href = 'http:\/\/www.shenjianan.top\/'"></i>
  </div>
  <div class="item">
    <i class="large link icon theme-switch" onclick="themeSwitch()"></i>
  </div>
</nav>

          <div class="ui centered relaxed grid dream-grid dream-back">
  
    <section class="sixteen wide mobile eight wide tablet four wide computer column dream-column">
      <article>
        <div class="ui top attached segment">
          <h3 class="ui header">About Me</h3>
        </div>
        <div class="ui attached segment markdown-body">
          <h4 id="201802至今emsp杭州嘉云数据-算法引擎">2018.02至今 杭州嘉云数据 算法引擎</h4>
<h4 id="20176-201712emsp菜网络-工智能部-算法引擎">2017.6-2017.12 菜⻦网络-⼈工智能部-算法引擎</h4>
<h4 id="201609-201806emsp南京大学研究生">2016.09-2018.06 南京大学研究生</h4>
<h4 id="201507-201509emsp阿里巴巴-icbu-实习">2015.07-2015.09 阿里巴巴-ICBU-实习</h4>
<h4 id="201209-201606emsp南京大学本科">2012.09-2016.06 南京大学本科</h4>

        </div>
      </article>
    </section>
  

  <section class="sixteen wide mobile eight wide tablet four wide computer column dream-column">
    <article>
      <div class="ui top attached segment">
        <h3 class="ui header">Social Links</h3>
      </div>
      <div class="ui attached segment">
        <nav class="ui secondary menu dream-menu dream-socials">
  
    <div class="item">
      <i class="large mail icon" title="email"></i> 
      <a href="mailto:shen_jianan@foxmail.com">
        shen_jianan@foxmail.com
      </a>
    </div>
  

  

  

  

  

  

  

  
</nav>

      </div>
    </article>
  </section>

  <section class="sixteen wide mobile eight wide tablet four wide computer column dream-column">
    
      <footer class="ui segment">
        <strong>欢迎通过<a href="mailto:shen_jianan@foxmail.com">邮箱</a>(shen_jianan@foxmail.com)探讨问题</strong> <br/><br/><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。 <br />
      </footer>
    
  </section>

  
  
</div>

        </section>
      </div>
    </div>

    <script src="/js/jquery.min.js"></script>
<script src="/js/semantic.min.js"></script>
<script src="/js/imagesloaded.pkgd.min.js"></script>
<script src="/js/masonry.pkgd.min.js"></script>
<script src="/js/nav.js"></script>
<script src="/js/header.js"></script>
<script src="/js/main.js"></script>
<script src="/js/theme.js"></script>
<script src="/js/html2canvas.min.js"></script>



  </body>
</html>
